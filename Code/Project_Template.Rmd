---
title: "The very basics of R"
author: "Josh Salzberg, Yitong Eric Su, and Sarah Slay"
date: "12/12/2025"
output:
  html_document:
    toc: true
    lof: true
    number_sections: true
editor_options:
  chunk_output_type: console
subtitle: https://github.com/sytspg/SalzbergSuSlay/

---

```{r setup, include=FALSE}
# Set global options for R chunks
knitr::opts_chunk$set(
	echo = FALSE,
	message = FALSE,
	warning = FALSE)

# Load your packages
library(tidyverse)
library(here)
library(gridExtra)
library(knitr)
library(broom)
library(ggcorrplot)
library(visreg)
library(plotly)
library(ggrepel)
library(ggExtra)
library(scales)
library(ggthemes)
library(cowplot)
library(sf)
library(mapview)
library(leaflet)
library(stringr)

# Set your working directory
here()
getwd()

# Set your ggplot theme
mytheme <- theme_classic(base_size = 14) +
  theme(axis.text = element_text(color = "black"), 
        legend.position = "right",
        plot.title = element_text(size = 12),
        plot.subtitle = element_text(size = 11),
        axis.title.x = element_text(size =10),
        axis.title.y = element_text(size =10),
        axis.text.x = element_text(size =8),
        axis.text.y = element_text(size =8),
        legend.title = element_text(size =9),
        legend.text = element_text(size = 8),
        legend.key.size = unit(0.5, "lines"))
theme_set(mytheme)
```

```{r}
# Load your datasets
NCData <- read.csv(here('Data','Processed','NCDataClean.csv'), stringsAsFactors = T)
NCweather_TS <- read.csv(here('Data','Processed','NCDataClean.csv'), stringsAsFactors = T)

```

# Rationale and Research Questions

The goal of our analysis is to determine whether household income is correlated with specific climate change indicators. Due to redlining and disenfranchisement, low-income households tend to be located in areas more vulnerable to climate change. Determining whether household income is correlated with indicators such as flood risk or heat index informs policy initiatives. For example, flood damage costs exceeded \$53 billion after hurricane Helene (Thomae, 2024). If flood risk increases with low-income households, these vulnerable populations would bear the highest cost. Policies for floodplain buyouts should aim to reduce cost burden for low-income households. 
In addition, extreme heat exposure worsens chronic health conditions and can lead to premature death. Areas with lower socioeconomic status have limited access to resources such as health clinics that could address heatstroke symptoms (EPA, 2024). Therefore, if low-income households have a higher number of extreme heat days, they are more likely to suffer adverse effects. Level of walkability may also lead to worse health outcomes. People in less walkable areas have fewer opportunities to engage in physical exercise.  

Lastly, we want to understand the distribution of climate change effects in NC. The varied topography and ecology of the state results in differing climate change impacts. Identifying counties with vulnerable populations will help decision-makers target policies to mitigate the effects of climate change.

We focused our analysis at the county level in North Carolina. Data was obtained for median household income and population distribution of each county, as well as climate change indicators. This data was wrangled and analyzed to answer the following questions:

1.  Does average household income correlate with walkability, flood risk, and heat indices? 
2.  Are specific counties disproportionately at risk of climate change?

\newpage

# Dataset Information

We obtained data from the NC Data Portal (https://ncdataportal.org/), a platform that gathers social and enviromental data related to North Carolina from government entities. By selecting specific parameters, we built a custom dataset. 

Our custom dataset describes household income and population for all 100 counties in NC using ACS estimates from 2019-2023. Data for flood hazard area was sourced from the EPA based on 2020 measurements. Each indicator has its own column for a total of 14 columns (Table 1). 


*Table 1: Summary of Data*

|                   Variable Name | Variable Description                                                                 |
|-------------------------------:|:---------------------------------------|
|                        `County` | Name of North Carolina county                                                        |
|              `Total.Population` | Count of county population                                                           |
|               `TotalHouseholds` | Count of county households                                                           |
|                      `AvgHHinc` | County average household income                                                      |
|                      `MedHHinc` | County median household income                                                       |
|                `WalkIndexScore` | County walkability score (based on EPA Walkability Index)                            |
|                     `LeastWalk` | Percent of population residing in area considered least walkable                     |
|                  `BelowAvgWalk` | Percent of population residing in area considered below average walkable             |
|                  `AboveAvgWalk` | Percent of population residing in area considered above average walkable             |
|                      `MostWalk` | Percent of population residing in area considered most walkable                      |
|                      `PopInFHA` | Count of county population residing in Flood Hazard Area                             |
|               `PercentPopInFHA` | Percent of county population residing in Flood Hazard Area                           |
| `DailyMaxHeatIndex95Percentile` | Count of days per year maximum daily temperature exceeded 95th percentile, 2022-2024 |


\newpage

## Census USA counties shapefile (cb_2018_us_county_20m.shp)

USA counties shapefile: this dataset provides mapping information for US counties and is filtered for just the NC counties (FIPS: 37).

# Exploratory Analysis

## Data Wrangling & Summary

No columns were created in the data wrangling process, only removed or cleaned cleaned. Upon download, we inspected the data using functions `head()`, `str()`, `dim()`, and `colnames()`. Notably, `str()` revealed both far more columns than we needed, and that much data was stored as strings due to non-numeric characters within the data, principally `$`, `%`, and `,`. To resolve this, we subset the data into a new data frame, and used a combination of `lapply()` and `gsub()` code to remove the non-numeric characters in the data based on solutions from this [StackOverflow thread](https://stackoverflow.com/questions/74461334/replace-character-values-across-several-columns-at-once). With the `%` sign removed from the data, we applied a minor manipulation to convert the percentage columns into decimal form.

The table below communicates the findings from the `summary()` function applied to selected variables which gives us a brief understanding of the data dimensions.

```{r, echo=FALSE}

#This table does not look good in the rendered html file. Can you try to just select a few data of interest and put them in a table manuaully?
SummaryKable <- NCData %>% 
  select(Total.Population,
         AvgHHinc,
         MedHHinc,
         WalkIndexScore,
         PopInFHA,
         PercentPopInFHA)

kable(summary(SummaryKable))
```

## Data Distribution

Our exploratory analysis indicates that population count is right skewed because the mean is larger than the median. The graph, figure 1A below, provides visual proof. We identified two outlier counties with populations over 1 million as Wake and Mecklenburg Counties. The significant range in county population has implications for our analysis. 

Figure 1B shows that household income does not demonstrate the same absolute magnitude in range.  However, average household income exhibits rightward skew due to the highest income households bringing averages up. For median household income, the range is much smaller, and is less influenced by the largest incomes in each county. Capturing this difference helps us understand the extent of income ranges between and within counties. 

Figure 1C demonstrates that approximately three quarters of counties in North Carolina have fewer than 10% of their population inhabiting Flood Hazard Areas. However, there are three counties with over 50% of their population residing in Flood Hazard Areas. The highest rate shown is nearly 95% of residents. To accommodate such a dramatic skew in our analysis, we apply a log transformation to normalize the distribution. 

Lastly, in Figure 1D, we explore how the number of days over the county's 95th percentile Heat Index is distributed across the state. We can see that the data approximates a normal distribution, but further analysis would be required to confirm the goodness of fit, especially given the slightly off-center mode.

```{r, exploratory-plots, fig.width= 8, fig.cap="*Fig 1. Exploratory Analysis of Parameters*"}

PopPlot <- ggplot(data = NCData)+
  stat_bin(aes(x= Total.Population), binwidth=20000)+
  labs(title = "A: Total Population Distribution",
       subtitle = "Right Skew Confirmed \nBin Width = 20,000",
       x = "Total Population",
       y = "Count")+
  scale_x_continuous(labels = comma, breaks=breaks_pretty(3))
  

IncomePlot <- ggplot(data = NCData)+
  geom_histogram(aes(x=AvgHHinc), fill="red", alpha=0.5)+
  geom_vline(xintercept=97676, linetype='dashed', 
             color='red', linewidth=1)+
  geom_histogram(aes(x=MedHHinc), fill="blue", alpha=0.5)+
  geom_vline(xintercept=77228, linetype='dashed', 
             color='blue', linewidth=1)+
  labs(title = "B: Average and Median Household \nIncome Distributions",
       subtitle = "Red = Average, Blue = Median \nVertical lines represent distribution's average",
       x = "Household Income",
       y = "Count")+
  scale_x_continuous(labels = dollar,
                     breaks=breaks_pretty(3))

ResidentsinFHA <- ggplot(NCData, aes(PercentPopInFHA))+
  geom_histogram(stat = 'bin', fill="lightblue")+
  labs(title= "C: Percent of Residents in \nFlood Hazard Areas",
       x="% Residents in Flood Hazard Area",
       y="Count")+
  scale_x_continuous(labels = percent,
                     breaks=breaks_pretty(3))

DMHIPlot <- ggplot(NCData, aes(DailyMaxHeatIndex95Percentile))+
  geom_histogram(binwidth = 1, fill="lightblue")+
  labs(title = "D: Count of 95th Percentile \nDaily Max Heat Index Days",
       x="Number of Days over 95th Percentile",
       y="Count")+
  scale_x_continuous(breaks=seq(5,17), limit = c(6,15))

grid.arrange(PopPlot,IncomePlot,ResidentsinFHA,DMHIPlot,ncol=2)
```

Figure 2 demonstrates the percentage of residents in different designations of walkability. Level of walkability across the state is low. It appears a significant proportion of counties have well over half their population residing in "least walkable" and "below average walkable" conditions (plots A & B below). These two walkability designations approach normal distributions. Plots C & D, "above average walkable" and "most walkable," respectively, approach exponential distributions, with the majority of counties containing 0% of residents in the given walkability designation. 

```{r, walk-plots, fig.width=8, fig.cap="*Fig 2. Distribution of the Walkability-related Indices*"}
LeastWalkPlot <- ggplot(NCData, 
                        aes(x = LeastWalk))+
  geom_histogram(stat='bin',fill="lightblue")+
  labs(x="% Residents in \nLeast Walkable Conditions",
       y="# of Counties")+
  scale_x_continuous(labels=percent, limits = c(-.05,1))+
  scale_y_continuous(limits= c(-0.05,15))+
  mytheme

BelowAvgWalkPlot <- ggplot(NCData, 
                           aes(BelowAvgWalk))+
  geom_histogram(stat='bin',fill="lightblue")+
  labs(x="% Residents in \nBelow Average Walkable Conditions",
       y="# of Counties")+
  scale_x_continuous(labels=percent, limits = c(-.05,1))+
  scale_y_continuous(limits= c(-0.05,15))+
  mytheme

AboveAvgWalkPlot <- ggplot(NCData, 
                           aes(AboveAvgWalk))+
  geom_histogram(stat='bin',fill="lightblue")+
  labs(x="% Residents in \nAbove Average Walkable Conditions",
       y="# of Counties")+
  scale_x_continuous(labels=percent, limits = c(-.05,1))+
  scale_y_continuous(limits= c(-0.05,100))+
  mytheme


MostWalkPlot <- ggplot(NCData, 
                       aes(MostWalk))+
  geom_histogram(stat='bin',fill="lightblue")+
  labs(x="% Residents in \nMost Walkable Conditions",
       y="# of Counties")+
  scale_x_continuous(labels=percent, limits = c(-.05,1))+
  scale_y_continuous(limits= c(-0.05,100))+
  mytheme

plot_grid(LeastWalkPlot,
          BelowAvgWalkPlot,
          AboveAvgWalkPlot,
          MostWalkPlot, 
          align = 'hv',
          axis = 'tblr',
          labels = "AUTO")
```


## Question 1: \<insert specific question here and add additional subsections for additional questions below, if needed\>

SARAH: I think the research questions should be presented here after the exploratory analyses. Add a few sentences to explain the rationale of choosing the indices of interest, based on the plots above :).

## Question 2:

\newpage

# Analyses

\newpage

## Regression

```{r echo=FALSE, out.width="70%"}
NCData_corrplot <-NCData %>%
  mutate(log_Flood.Index = log(PercentPopInFHA),
         Avg.Household.Income.1000 = AvgHHinc/1000,
         Walkability.Index = BelowAvgWalk,
         Heat.Index = DailyMaxHeatIndex95Percentile) %>%
  select(c(Avg.Household.Income.1000, log_Flood.Index, 
           Walkability.Index, Heat.Index))

testcors <- cor(NCData_corrplot, use="complete.obs")
ggcorrplot(testcors,method="circle",type="lower", lab=TRUE, lab_size = 3.5, colors=c("#CCFFCC","white","orange"), title="Correlation plot of variables")

```


```{r eval=FALSE, include=FALSE}

Regression.Model1 <- lm(Heat.Index ~ Avg.Household.Income.1000, 
                       data = NCData_corrplot)
summary(Regression.Model1)

Regression.Model2 <- lm(Walkability.Index ~ Avg.Household.Income.1000, 
                       data = NCData_corrplot)
summary(Regression.Model2)

```

```{r echo=FALSE, plot.width = 12}

p6<- ggplot(NCData_corrplot, aes(Avg.Household.Income.1000, Heat.Index))+
  geom_jitter()+
  geom_smooth( method="lm", formula=y~x, se=FALSE)+
  labs( x="Mean Household Income*10^3", y="Days above 95th Percentile Daily Max Heat")

p7<- ggplot(NCData_corrplot, aes(Avg.Household.Income.1000, Walkability.Index))+
  geom_jitter()+
  geom_smooth( method="lm", formula=y~x, se=FALSE)+
  labs(x="Mean Household Income*10^3", y ="Percent Population Below Avg Walkability")

p8 <- ggplot(NCData_corrplot, aes(Avg.Household.Income.1000, log_Flood.Index))+
  geom_jitter()+
  geom_smooth( method="lm", formula=y~x, se=FALSE)+
  labs(x="Mean Household Income*10^3", y= "log(Percent Population in Flood Hazard)")

grid.arrange(p6,p7, p8,ncol=3)

```


\newpage

## Spatial Analysis

```{r Read the county data into an sf dataframe, echo=FALSE, plot.height=12, plot.width=12}
#3. Read in Counties shapefile into an sf dataframe, filtering for just NE counties
NC_counties <- st_read(here("Data", "Spatial", "cb_2018_us_county_20m.shp")) %>%
  filter(STATEFP == "37")

# select the county
NCData_County <- NCData %>%
  mutate(NAME = str_sub(County, start=1, end=-11))

NC_counties_with_NCData <- merge(NC_counties, NCData_County, by = "NAME")

#5. Plot the data

# Heat
#View using ggplot
p10 <- ggplot(data = NC_counties_with_NCData) + geom_sf(aes(fill = AvgHHinc))+
  labs(title = "Mean Household Income ($)", fill = "Legend")

#View using mapview
#p10 <- mapview(NC_counties_with_NCData, zcol = 'AvgHHinc', legend = TRUE, 
        #layer.name = "Average Income of Each County ($)")

p11 <- ggplot(data = NC_counties_with_NCData) + 
  geom_sf(aes(fill = DailyMaxHeatIndex95Percentile))+
  labs(title = "Days above 95th Percentile \n Daily Max Heat", fill = "Legend")

p12 <- ggplot(data = NC_counties_with_NCData) + 
  geom_sf(aes(fill = PercentPopInFHA))+
  labs(title = "Percent Population \n in Flood Hazard (%)", fill = "Legend")

p13 <- ggplot(data = NC_counties_with_NCData) + 
  geom_sf(aes(fill = BelowAvgWalk))+
  labs(title = "Percent Population \n Below Mean Walkability (%)", fill = "Legend")

grid.arrange(p10, p11, p12, p13,ncol=2)

```

\newpage

## Time Series



# Summary and Conclusions

\newpage

# References

Environmental Protection Agency. (2024). Climate Change and the Health of Socially Vulnerable People. EPA. <https://www.epa.gov/climateimpacts/climate-change-and-health-socially-vulnerable-people>

Thomae, L. (2024, December 3). Helene damage costs in NC more than \$53 billion. who will pay is unclear. Carolina Public Press. <https://carolinapublicpress.org/67325/helene-costs-nc-billions-unclear-who-pays/>
